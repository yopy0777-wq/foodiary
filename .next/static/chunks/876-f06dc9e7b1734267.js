"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[876],{3779:function(e,t,r){r.r(t),r.d(t,{AuthProvider:function(){return l},useAuth:function(){return s}});var n=r(3827),a=r(4090),i=r(4958);let o=(0,a.createContext)(void 0);function l(e){let{children:t}=e,[r,l]=(0,a.useState)(null),[s,u]=(0,a.useState)(null),[c,d]=(0,a.useState)(!0),w=(0,i.e)(),f=(0,i.j)(),p=(0,a.useCallback)(async e=>{if(!w)return null;let{data:t,error:r}=await w.from("profiles").select("*").eq("id",e).single();return r?(console.error("プロフィール取得エラー:",r),null):t},[w]);(0,a.useEffect)(()=>{if(!w){d(!1);return}(async()=>{let{data:{session:e}}=await w.auth.getSession();(null==e?void 0:e.user)&&(l(e.user),u(await p(e.user.id))),d(!1)})();let{data:{subscription:e}}=w.auth.onAuthStateChange(async(e,t)=>{(null==t?void 0:t.user)?(l(t.user),u(await p(t.user.id))):(l(null),u(null)),d(!1)});return()=>{e.unsubscribe()}},[w,p]);let h={user:r,profile:s,loading:c,signUp:async(e,t)=>{if(!w)return{error:Error("Supabaseが設定されていません")};let{error:r}=await w.auth.signUp({email:e,password:t,options:{emailRedirectTo:"".concat(window.location.origin,"/auth/callback")}});return{error:r}},signIn:async(e,t)=>{if(!w)return{error:Error("Supabaseが設定されていません")};let{error:r}=await w.auth.signInWithPassword({email:e,password:t});return{error:r}},signOut:async()=>{w&&(await w.auth.signOut(),l(null),u(null))},isAuthenticated:!!r,plan:(null==s?void 0:s.plan)||"free",isConfigured:f};return(0,n.jsx)(o.Provider,{value:h,children:t})}function s(){let e=(0,a.useContext)(o);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},339:function(e,t,r){r.d(t,{px:function(){return h},Ps:function(){return I},hv:function(){return O},pO:function(){return g},C0:function(){return y},e9:function(){return m},PZ:function(){return b},ld:function(){return v}});var n=r(7012),a=r(1161),i=r(4958);let o="food-photos",l=async(e,t,r)=>{let n=(0,i.e)();if(!n)return null;let a="".concat(e,"/").concat(t,".jpg"),{error:l}=await n.storage.from(o).upload(a,r,{contentType:"image/jpeg",upsert:!0});return l?(console.error("写真アップロードエラー:",l),null):a},s=async e=>{let t=(0,i.e)();if(!t)return null;let{data:r,error:n}=await t.storage.from(o).createSignedUrl(e,3600);return n?(console.error("URL取得エラー:",n),null):r.signedUrl},u=async e=>{let t=(0,i.e)();if(!t)return!1;let{error:r}=await t.storage.from(o).remove([e]);return!r||(console.error("写真削除エラー:",r),!1)},c="entries",d=null,w=()=>(d||(d=(0,n.openDB)("FoodDiaryDB",1,{upgrade(e){e.objectStoreNames.contains(c)||e.createObjectStore(c,{keyPath:"id"}).createIndex("by-date","date")}})),d),f=async()=>{try{if(await (0,a.yv)()){let e=await p();await (0,a.saveToFile)(e)}}catch(e){console.error("ファイル同期に失敗しました:",e)}},p=async()=>{let e=await w();return(await e.getAllFromIndex(c,"by-date")).sort((e,t)=>{let r="".concat(e.date,"T").concat(e.time||"00:00");return"".concat(t.date,"T").concat(t.time||"00:00").localeCompare(r)})},h=async(e,t)=>{if(S(t))await B(e,t.userId);else{let t=await w();await t.add(c,e),await f()}},y=async e=>S(e)?A(e.userId):p(),m=async(e,t)=>{if(S(t))return j(e,t.userId);let r=await w();return await r.get(c,e)},g=async(e,t)=>{if(S(t))await P(e,t.userId);else{let t=await w();await t.delete(c,e),await f()}},v=async(e,t)=>{if(S(t))await _(e,t.userId);else{let t=await w();await t.put(c,e),await f()}},b=async e=>{let t=(await w()).transaction(c,"readwrite");for(let r of e)await t.store.put(r);await t.done,await f()},I=async()=>{let e=await w();await e.clear(c)},S=e=>!!((null==e?void 0:e.userId)&&(null==e?void 0:e.isAuthenticated)),D=(e,t,r)=>({id:e.id,user_id:t,date:e.date,time:e.time||null,meal_type:e.mealType,menu:e.menu||null,photo_url:r,created_at:e.createdAt}),E=async e=>{let t;if(e.photo_url){let r=await s(e.photo_url);if(r)try{let e=await fetch(r);t=await e.blob()}catch(e){console.error("写真の取得に失敗しました:",e)}}return{id:e.id,date:e.date,time:e.time||void 0,mealType:e.meal_type,menu:e.menu||void 0,photo:t,createdAt:e.created_at}},B=async(e,t)=>{let r=(0,i.e)();if(!r)throw Error("Supabase が設定されていません");let n=null;e.photo&&(n=await l(t,e.id,e.photo));let a=D(e,t,n),{error:o}=await r.from("food_entries").insert(a);if(o)throw n&&await u(n),o},A=async e=>{let t=(0,i.e)();if(!t)return[];let{data:r,error:n}=await t.from("food_entries").select("*").eq("user_id",e).order("date",{ascending:!1}).order("time",{ascending:!1,nullsFirst:!1});return n?(console.error("Supabase からの取得エラー:",n),[]):await Promise.all(r.map(E))},j=async(e,t)=>{let r=(0,i.e)();if(!r)return;let{data:n,error:a}=await r.from("food_entries").select("*").eq("id",e).eq("user_id",t).single();if(a){console.error("Supabase からの取得エラー:",a);return}return E(n)},_=async(e,t)=>{let r=(0,i.e)();if(!r)throw Error("Supabase が設定されていません");let{data:n}=await r.from("food_entries").select("photo_url").eq("id",e.id).eq("user_id",t).single(),a=(null==n?void 0:n.photo_url)||null;e.photo?a=await l(t,e.id,e.photo):a&&!e.photo&&(await u(a),a=null);let o=D(e,t,a),{error:s}=await r.from("food_entries").update(o).eq("id",e.id).eq("user_id",t);if(s)throw s},P=async(e,t)=>{let r=(0,i.e)();if(!r)throw Error("Supabase が設定されていません");let{data:n}=await r.from("food_entries").select("photo_url").eq("id",e).eq("user_id",t).single(),a=null==n?void 0:n.photo_url;a&&await u(a);let{error:o}=await r.from("food_entries").delete().eq("id",e).eq("user_id",t);if(o)throw o},O=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:800,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:800,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.8;return new Promise((a,i)=>{let o=new FileReader;o.readAsDataURL(e),o.onload=e=>{var o;let l=new Image;l.src=null===(o=e.target)||void 0===o?void 0:o.result,l.onload=()=>{let e=document.createElement("canvas"),o=l.width,s=l.height;o>s?o>t&&(s*=t/o,o=t):s>r&&(o*=r/s,s=r),e.width=o,e.height=s;let u=e.getContext("2d");null==u||u.drawImage(l,0,0,o,s),e.toBlob(e=>{e?a(e):i(Error("画像の圧縮に失敗しました"))},"image/jpeg",n)},l.onerror=i},o.onerror=i})}},1161:function(e,t,r){r.d(t,{DB:function(){return o},Is:function(){return g},OK:function(){return w},VE:function(){return m},eR:function(){return y},j7:function(){return c},saveToFile:function(){return h},vU:function(){return v},yv:function(){return d}});let n="foodiary-data.json",a="file-handles",i="directory-handle",o=()=>"showDirectoryPicker"in window,l=async e=>{let{openDB:t}=await Promise.resolve().then(r.bind(r,7012)),n=await t("FileHandleStore",1,{upgrade(e){e.objectStoreNames.contains(a)||e.createObjectStore(a)}});await n.put(a,e,i)},s=async()=>{try{let{openDB:e}=await Promise.resolve().then(r.bind(r,7012)),t=await e("FileHandleStore",1,{upgrade(e){e.objectStoreNames.contains(a)||e.createObjectStore(a)}});return await t.get(a,i)||null}catch(e){return null}},u=async e=>{let t={mode:"readwrite"};return await e.queryPermission(t)==="granted"||await e.requestPermission(t)==="granted"},c=async()=>{if(!o())return null;try{let e=await window.showDirectoryPicker({mode:"readwrite",startIn:"documents"});return await l(e),e}catch(e){if(e instanceof Error&&"AbortError"===e.name)return null;throw e}},d=async()=>{let e=await s();return e&&await u(e)?e:null},w=async()=>null!==await s(),f=async e=>{let t={...e};if(e.photo instanceof Blob){let r=new FileReader,n=await new Promise((t,n)=>{r.onload=()=>t(r.result),r.onerror=n,r.readAsDataURL(e.photo)});t.photo=n,t._photoIsBase64=!0}return t},p=async e=>{let{_photoIsBase64:t,...r}=e,n=r.mealType||"昼食",a=r.menu||r.menuName,i={id:r.id,date:r.date,time:r.time,mealType:n,menu:a,photo:r.photo,createdAt:r.createdAt};if(t&&"string"==typeof r.photo){let e=await fetch(r.photo);i.photo=await e.blob()}return i},h=async e=>{let t=await d();if(!t)return!1;try{let r=await t.getFileHandle(n,{create:!0}),a=await r.createWritable(),i=await Promise.all(e.map(e=>f(e))),o=JSON.stringify({version:1,exportedAt:new Date().toISOString(),entries:i},null,2);return await a.write(o),await a.close(),!0}catch(e){return console.error("ファイルへの保存に失敗しました:",e),!1}},y=async()=>{let e=await d();if(!e)return null;try{let t=await e.getFileHandle(n),r=await t.getFile(),a=await r.text(),i=JSON.parse(a);if(!i.entries||!Array.isArray(i.entries))return null;return await Promise.all(i.entries.map(e=>p(e)))}catch(e){if(e instanceof Error&&"NotFoundError"===e.name)return[];return console.error("ファイルからの読み込みに失敗しました:",e),null}},m=async e=>{let t=await Promise.all(e.map(e=>f(e))),r=JSON.stringify({version:1,exportedAt:new Date().toISOString(),entries:t},null,2),n=new Blob([r],{type:"application/json"}),a=URL.createObjectURL(n),i=document.createElement("a");i.href=a,i.download="foodiary-backup-".concat(new Date().toISOString().split("T")[0],".json"),document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(a)},g=async e=>{let t=JSON.parse(await e.text());if(!t.entries||!Array.isArray(t.entries))throw Error("無効なファイル形式です");return await Promise.all(t.entries.map(e=>p(e)))},v=async()=>{let{openDB:e}=await Promise.resolve().then(r.bind(r,7012)),t=await e("FileHandleStore",1,{upgrade(e){e.objectStoreNames.contains(a)||e.createObjectStore(a)}});await t.delete(a,i)}},4958:function(e,t,r){r.d(t,{e:function(){return s},j:function(){return o}});var n=r(6070);let a="https://lebexzzbtaiuegztwupu.supabase.co",i="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxlYmV4enpidGFpdWVnenR3dXB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NDQ5ODYsImV4cCI6MjA4NTEyMDk4Nn0.R0AGgMNWuhnWeNz6TpGQOB9yVWj7NGkZDGV_M4o9Sgo",o=()=>!!(a&&i),l=null,s=()=>o()?(l||(l=(0,n.createBrowserClient)(a,i)),l):null},7012:function(e,t,r){var n,a;let i,o;r.d(t,{openDB:function(){return p}});let l=(e,t)=>t.some(t=>e instanceof t),s=new WeakMap,u=new WeakMap,c=new WeakMap,d={get(e,t,r){if(e instanceof IDBTransaction){if("done"===t)return s.get(e);if("store"===t)return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return w(e[t])},set:(e,t,r)=>(e[t]=r,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function w(e){var t;if(e instanceof IDBRequest)return function(e){let t=new Promise((t,r)=>{let n=()=>{e.removeEventListener("success",a),e.removeEventListener("error",i)},a=()=>{t(w(e.result)),n()},i=()=>{r(e.error),n()};e.addEventListener("success",a),e.addEventListener("error",i)});return c.set(t,e),t}(e);if(u.has(e))return u.get(e);let r="function"==typeof(t=e)?(o||(o=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(){for(var e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];return t.apply(f(this),r),w(this.request)}:function(){for(var e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];return w(t.apply(f(this),r))}:(t instanceof IDBTransaction&&function(e){if(s.has(e))return;let t=new Promise((t,r)=>{let n=()=>{e.removeEventListener("complete",a),e.removeEventListener("error",i),e.removeEventListener("abort",i)},a=()=>{t(),n()},i=()=>{r(e.error||new DOMException("AbortError","AbortError")),n()};e.addEventListener("complete",a),e.addEventListener("error",i),e.addEventListener("abort",i)});s.set(e,t)}(t),l(t,i||(i=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])))?new Proxy(t,d):t;return r!==e&&(u.set(e,r),c.set(r,e)),r}let f=e=>c.get(e);function p(e,t){let{blocked:r,upgrade:n,blocking:a,terminated:i}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=indexedDB.open(e,t),l=w(o);return n&&o.addEventListener("upgradeneeded",e=>{n(w(o.result),e.oldVersion,e.newVersion,w(o.transaction),e)}),r&&o.addEventListener("blocked",e=>r(e.oldVersion,e.newVersion,e)),l.then(e=>{i&&e.addEventListener("close",()=>i()),a&&e.addEventListener("versionchange",e=>a(e.oldVersion,e.newVersion,e))}).catch(()=>{}),l}let h=["get","getKey","getAll","getAllKeys","count"],y=["put","add","delete","clear"],m=new Map;function g(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&"string"==typeof t))return;if(m.get(t))return m.get(t);let r=t.replace(/FromIndex$/,""),n=t!==r,a=y.includes(r);if(!(r in(n?IDBIndex:IDBObjectStore).prototype)||!(a||h.includes(r)))return;let i=async function(e){for(var t=arguments.length,i=Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];let l=this.transaction(e,a?"readwrite":"readonly"),s=l.store;return n&&(s=s.index(i.shift())),(await Promise.all([s[r](...i),a&&l.done]))[0]};return m.set(t,i),i}d={...n=d,get:(e,t,r)=>g(e,t)||n.get(e,t,r),has:(e,t)=>!!g(e,t)||n.has(e,t)};let v=["continue","continuePrimaryKey","advance"],b={},I=new WeakMap,S=new WeakMap,D={get(e,t){if(!v.includes(t))return e[t];let r=b[t];return r||(r=b[t]=function(){for(var e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];I.set(this,S.get(this)[t](...r))}),r}};async function*E(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];let n=this;if(n instanceof IDBCursor||(n=await n.openCursor(...t)),!n)return;let a=new Proxy(n,D);for(S.set(a,n),c.set(a,f(n));n;)yield a,n=await (I.get(a)||n.continue()),I.delete(a)}function B(e,t){return t===Symbol.asyncIterator&&l(e,[IDBIndex,IDBObjectStore,IDBCursor])||"iterate"===t&&l(e,[IDBIndex,IDBObjectStore])}d={...a=d,get:(e,t,r)=>B(e,t)?E:a.get(e,t,r),has:(e,t)=>B(e,t)||a.has(e,t)}}}]);